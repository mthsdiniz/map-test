<!DOCTYPE html>
<html>

<head>
    <title>Flask Leaflet App</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-omnivore/0.3.4/leaflet-omnivore.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder@2.2.0/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder@2.2.0/dist/Control.Geocoder.js"></script>

    <!-- new -->
    <!-- Add these lines to your HTML file -->
    <script src="https://unpkg.com/leaflet-geotiff"></script>
    <script src="https://unpkg.com/leaflet-geotiff-2"></script>
    <script src="https://unpkg.com/plotty"></script>



    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }

        .container {
            max-width: 600px;
        }

        .form-control {
            border-radius: 50px;
            padding-left: 20px;
            padding-right: 20px;
            font-size: 16px;
            border-color: #b0b0b0;
        }

        .btn {
            border-radius: 50px;
            font-size: 16px;
            border-color: #b0b0b0;
        }

        .form-control:focus {
            border-color: #808080;
            outline: none;
            box-shadow: none;
        }

        .btn {
            background-color: transparent;
            color: #808080;
            font-weight: bold;
        }

        .btn:hover,
        .btn:focus {
            background-color: #808080;
            color: #ffffff;
        }

        #file-dropdown {
            text-align: center;
        }

        /* Style the container for the checkboxes */
        #checkboxList {
            background-color: white;
            border-radius: 5px;
            padding: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
        }

        /* Style the individual checkbox items */
        #checkboxList div {
            margin-bottom: 5px;
        }

        /* Style the label for better text alignment */
        #checkboxList label {
            display: inline-flex;
            align-items: center;
        }

        /* Style the checkbox with a custom appearance */
        #checkboxList input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin-right: 5px;
            border: 1px solid #ccc;
            background-color: white;
            border-radius: 3px;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
        }

        /* Style the checkbox when checked */
        #checkboxList input[type="checkbox"]:checked {
            background-color: #007bff;
            border-color: #007bff;
            position: relative;
        }

        /* Add a checkmark icon when the checkbox is checked */
        #checkboxList input[type="checkbox"]:checked::after {
            content: "";
            width: 5px;
            height: 9px;
            border: solid white;
            border-width: 0 2px 2px 0;
            position: absolute;
            top: 3px;
            left: 6px;
            transform: rotate(45deg);
        }

        /* Style the container for the "Select All" checkbox */
        #selectAllContainer {
            background-color: white;
            border-radius: 5px;
            padding: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            margin-bottom: 10px;
        }

        /* Style the "Select All" label for better text alignment */
        #selectAllContainer label {
            display: inline-flex;
            align-items: center;
        }

        /* Style the "Select All" checkbox with a custom appearance */
        #selectAllContainer input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin-right: 5px;
            border: 1px solid #ccc;
            background-color: white;
            border-radius: 3px;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
        }

        /* Style the "Select All" checkbox when checked */
        #selectAllContainer input[type="checkbox"]:checked {
            background-color: #007bff;
            border-color: #007bff;
            position: relative;
        }

        /* Add a checkmark icon when the "Select All" checkbox is checked */
        #selectAllContainer input[type="checkbox"]:checked::after {
            content: "";
            width: 5px;
            height: 9px;
            border: solid white;
            border-width: 0 2px 2px 0;
            position: absolute;
            top: 3px;
            left: 6px;
            transform: rotate(45deg);
        }
    </style>

</head>

<body style="margin:0; padding:0;">
    <div class="container mt-3">
        <div class="row mb-2">
            <div class="col-md-12">
                <input type="text" class="form-control" id="username" placeholder="Username">
            </div>
        </div>
        <div class="row mb-2">
            <div class="col-md-12">
                <input type="text" class="form-control" id="repo-name" placeholder="Repo name">
            </div>
        </div>
        <div class="row mb-2">
            <div class="col-md-12">
                <input type="text" class="form-control" id="access-token" placeholder="GitHub Access Token">
            </div>
        </div>
        <div class="row mb-4">
            <div class="col-md-12">
                <button class="btn btn-primary btn-block" id="fetch-files-btn">Fetch Files</button>
            </div>
        </div>
        <div class="row mb-4">
            <div class="col-md-12">
                <div id="file-panel" class="mt-3"></div>
            </div>
        </div>
        <!-- Add a "Select All" checkbox -->


        <div class="row">
            <div class="col-md-12">
                <!-- Add a container for the "Select All" checkbox -->
                <div id="selectAllContainer">
                    <label>
                        <input type="checkbox" id="selectAll">
                        Select All
                    </label>
                </div>
                <!-- Add a scrollable list container for checkboxes -->
                <div id="checkboxList"
                    style="max-height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 8px;">
                </div>
            </div>
        </div>
    </div>

    <div id="map" style="width: 100%; height: 100vh;"></div>
    <script>
        // Fetch KML and GeoJSON files from GitHub recursively
        async function fetchGitHubFiles(url, headers) {
            const response = await fetch(url, { headers });
            const data = await response.json();
            let files = [];

            for (const item of data) {
                if (item.type === 'dir') {
                    const subdirFiles = await fetchGitHubFiles(item.url);
                    files = files.concat(subdirFiles);
                } else if (item.name.endsWith('.kml') || item.name.endsWith('.geojson')) {
                    files.push(item);
                }
            }
            console.log(files)
            return files;
        }

        // Initialize the Leaflet map
        const map = L.map('map').setView([0, 0], 2);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Replace 'username', 'repo-name', and 'path-to-files' with the appropriate values
        const repoUrl = 'https://api.github.com/repos/username/repo-name/contents/path-to-files';

        function fetchFiles() {
            const username = document.getElementById('username').value;
            const repoName = document.getElementById('repo-name').value;
            const accessToken = document.getElementById('access-token').value;

            const headers = {
                'Accept': 'application/vnd.github.v3+json',
                'Authorization': `token ${accessToken}`
            };

            const repoUrl = `/api/proxy`;

            // Add KML and GeoJSON files to the map
            fetchGitHubFiles(repoUrl, headers).then(files => {
                files.forEach(file => {
                    const fileType = file.name.split('.').pop().toLowerCase();

                    fetchGitHubFiles(`/api/proxy`, {
                        'Authorization': `token ${accessToken}`
                    }, file.url).then(data => {
                        if (fileType === 'kml') {
                            const kmlLayer = omnivore.kml.parse(data);
                            kmlLayer.addTo(map);
                        } else if (fileType === 'geojson') {
                            const geojsonLayer = L.geoJSON(JSON.parse(data));
                            geojsonLayer.addTo(map);
                        }
                    });
                });
            });
        }

        populateCheckboxes(files);

        function fetchGitHubFiles(url, headers, fileUrl = '') {
            const payload = {
                url: fileUrl || `https://api.github.com/repos/${username}/${repoName}/contents/path-to-files`,
                headers: headers
            };

            return fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            }).then(response => response.json());
        }

        // Attach event listener to the button
        document.getElementById('fetch-files-btn').addEventListener('click', fetchFiles);

        // Initialize the Select2 dropdown
        $("#file-dropdown").select2();

        // Event listener for when a file is selected
        $("#file-dropdown").on("select2:select", function (e) {
            const layerId = e.params.data.id;
            const layer = map._layers[layerId];
            map.fitBounds(layer.getBounds());
        });

        function populateDropdown(files) {
            const CustomGeocoder = L.Control.Geocoder.extend({
                initialize: function (fileOptions) {
                    this.fileOptions = fileOptions;
                },
                geocode: function (query, cb, context) {
                    const results = this.fileOptions.filter((fileOption) =>
                        fileOption.name.toLowerCase().includes(query.toLowerCase())
                    );
                    cb.call(context, results);
                },
                reverse: function () { },
            });

            const searchControl = new L.Control.Geocoder({
                geocoder: new CustomGeocoder(
                    files.map((file) => {
                        return {
                            name: file.path,
                            file: file,
                        };
                    })
                ),
                showResultIcons: false,
                placeholder: 'Search for a file...',
                errorMessage: 'File not found',
            });

            searchControl.addTo(map);
            searchControl.markGeocode = function (result) {
                map.fitBounds(result.file.layer.getBounds());
            };
        }


        fetch(url_to_geotiff_file)
            .then(response => response.arrayBuffer())
            .then(arrayBuffer => {
                parseGeoraster(arrayBuffer).then(georaster => {
                    console.log("georaster:", georaster);

                    const url_to_geotiff_file = "your-geotiff-url";

                    fetch("/fetch_geotiff", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ url: url_to_geotiff_file }),
                    })
                        .then((response) => response.arrayBuffer())
                        .then((arrayBuffer) => {
                            const geotiff = GeoTIFF.parse(arrayBuffer);
                            const image = geotiff.getImage();
                            const rasters = image.readRasters();

                            const plottyRenderer = new L.LeafletGeotiff.Plotty({
                                colorScale: "viridis",
                                displayMin: 0,
                                displayMax: 255,
                            });

                            const geotiffLayer = new L.leafletGeotiff(image, rasters, {
                                renderer: plottyRenderer,
                                opacity: 0.7,
                            }).addTo(map);

                            map.fitBounds(geotiffLayer.getBounds());
                        });

                    function populateCheckboxes(files) {
                        const panel = document.getElementById('file-panel');
                        panel.innerHTML = '';

                        files.forEach((file) => {
                            const checkBox = document.createElement('input');
                            checkBox.type = 'checkbox';
                            checkBox.id = file.path;
                            checkBox.name = file.path;

                            const label = document.createElement('label');
                            label.htmlFor = file.path;
                            label.appendChild(document.createTextNode(file.path));

                            checkBox.addEventListener('change', async () => {
                                if (checkBox.checked) {
                                    await addLayer(file);
                                } else {
                                    removeLayer(file);
                                }
                            });

                            const div = document.createElement('div');
                            div.appendChild(checkBox);
                            div.appendChild(label);
                            panel.appendChild(div);
                        });
                    }

                    function populateCheckboxes(files) {
                        const checkboxList = document.getElementById("checkboxList");
                        checkboxList.innerHTML = "";

                        files.forEach((file) => {
                            const listItem = document.createElement("div");
                            const label = document.createElement("label");
                            const checkbox = document.createElement("input");

                            checkbox.type = "checkbox";
                            checkbox.name = "files";
                            checkbox.value = file;
                            label.appendChild(checkbox);
                            label.appendChild(document.createTextNode(file));

                            listItem.appendChild(label);
                            checkboxList.appendChild(listItem);
                        });
                    }

                    async function addLayer(file) {
                        const fileType = file.path.split('.').pop().toLowerCase();

                        const response = await fetch(`/api/proxy`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                url: file.url,
                                headers: {
                                    Accept: 'application/vnd.github.v3+json',
                                    Authorization: `token ${document.getElementById('access-token').value}`,
                                },
                            }),
                        });

                        if (response.ok) {
                            const data = await response.text();

                            if (fileType === 'kml') {
                                const kmlBlob = new Blob([data], { type: 'application/vnd.google-earth.kml+xml' });
                                const kmlLayer = omnivore.kml.parse(kmlBlob);
                                kmlLayer.addTo(map);
                                file.layer = kmlLayer;
                            } else if (fileType === 'geojson') {
                                const geojsonLayer = L.geoJSON(JSON.parse(data));
                                geojsonLayer.addTo(map);
                                file.layer = geojsonLayer;
                            }
                        } else {
                            throw new Error(`Error fetching ${file.path}: ${response.status} ${response.statusText}`);
                        }
                    }

                    function removeLayer(file) {
                        if (file.layer) {
                            map.removeLayer(file.layer);
                            delete file.layer;
                        }
                    }

                    document.getElementById("selectAll").addEventListener("change", function (event) {
                        const checkboxes = document.getElementsByName("files");
                        checkboxes.forEach((checkbox) => {
                            checkbox.checked = event.target.checked;
                        });
                    });


    </script>
</body>

</html>