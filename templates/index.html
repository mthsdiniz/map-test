<!DOCTYPE html>
<html>

<head>
    <title>Flask Leaflet App</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-omnivore/0.3.4/leaflet-omnivore.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder@2.2.0/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder@2.2.0/dist/Control.Geocoder.js"></script>


    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }

        .container {
            max-width: 600px;
        }

        .form-control {
            border-radius: 50px;
            padding-left: 20px;
            padding-right: 20px;
            font-size: 16px;
            border-color: #b0b0b0;
        }

        .btn {
            border-radius: 50px;
            font-size: 16px;
            border-color: #b0b0b0;
        }

        .form-control:focus {
            border-color: #808080;
            outline: none;
            box-shadow: none;
        }

        .btn {
            background-color: transparent;
            color: #808080;
            font-weight: bold;
        }

        .btn:hover,
        .btn:focus {
            background-color: #808080;
            color: #ffffff;
        }

        #file-dropdown {
            text-align: center;
        }
    </style>

</head>

<body style="margin:0; padding:0;">
    <div class="container mt-3">
        <div class="row mb-2">
            <div class="col-md-12">
                <input type="text" class="form-control" id="username" placeholder="Username">
            </div>
        </div>
        <div class="row mb-2">
            <div class="col-md-12">
                <input type="text" class="form-control" id="repo-name" placeholder="Repo name">
            </div>
        </div>
        <div class="row mb-2">
            <div class="col-md-12">
                <input type="text" class="form-control" id="access-token" placeholder="GitHub Access Token">
            </div>
        </div>
        <div class="row mb-4">
            <div class="col-md-12">
                <button class="btn btn-primary btn-block" id="fetch-files-btn">Fetch Files</button>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <select class="form-control" id="file-dropdown" style="width: 100%;">
                    <option value="" disabled selected>Select a file</option>
                </select>
            </div>
        </div>
    </div>

    <div id="map" style="width: 100%; height: 100vh;"></div>
    <script>
        // Fetch KML and GeoJSON files from GitHub recursively
        async function fetchGitHubFiles(url, headers) {
            const response = await fetch(url, { headers });
            const data = await response.json();
            let files = [];

            for (const item of data) {
                if (item.type === 'dir') {
                    const subdirFiles = await fetchGitHubFiles(item.url);
                    files = files.concat(subdirFiles);
                } else if (item.name.endsWith('.kml') || item.name.endsWith('.geojson')) {
                    files.push(item);
                }
            }
            console.log(files)
            return files;
        }

        // Initialize the Leaflet map
        const map = L.map('map').setView([0, 0], 2);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Replace 'username', 'repo-name', and 'path-to-files' with the appropriate values
        const repoUrl = 'https://api.github.com/repos/username/repo-name/contents/path-to-files';

        function fetchFiles() {
            const username = document.getElementById('username').value;
            const repoName = document.getElementById('repo-name').value;
            const accessToken = document.getElementById('access-token').value;

            const headers = {
                'Accept': 'application/vnd.github.v3+json',
                'Authorization': `token ${accessToken}`
            };

            const repoUrl = `/api/proxy`;

            // Add KML and GeoJSON files to the map
            fetchGitHubFiles(repoUrl, headers).then(files => {
                files.forEach(file => {
                    const fileType = file.name.split('.').pop().toLowerCase();

                    fetchGitHubFiles(`/api/proxy`, {
                        'Authorization': `token ${accessToken}`
                    }, file.url).then(data => {
                        if (fileType === 'kml') {
                            const kmlLayer = omnivore.kml.parse(data);
                            kmlLayer.addTo(map);
                        } else if (fileType === 'geojson') {
                            const geojsonLayer = L.geoJSON(JSON.parse(data));
                            geojsonLayer.addTo(map);
                        }
                    });
                });
            });
        }

        function fetchGitHubFiles(url, headers, fileUrl = '') {
            const payload = {
                url: fileUrl || `https://api.github.com/repos/${username}/${repoName}/contents/path-to-files`,
                headers: headers
            };

            return fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            }).then(response => response.json());
        }

        // Attach event listener to the button
        document.getElementById('fetch-files-btn').addEventListener('click', fetchFiles);

        // Initialize the Select2 dropdown
        $("#file-dropdown").select2();

        // Event listener for when a file is selected
        $("#file-dropdown").on("select2:select", function (e) {
            const layerId = e.params.data.id;
            const layer = map._layers[layerId];
            map.fitBounds(layer.getBounds());
        });

        function populateDropdown(files) {
            const CustomGeocoder = L.Control.Geocoder.extend({
                initialize: function (fileOptions) {
                this.fileOptions = fileOptions;
                },
                geocode: function (query, cb, context) {
                const results = this.fileOptions.filter((fileOption) =>
                    fileOption.name.toLowerCase().includes(query.toLowerCase())
                );
                cb.call(context, results);
                },
                reverse: function () {},
            });

            const searchControl = new L.Control.Geocoder({
                geocoder: new CustomGeocoder(
                files.map((file) => {
                    return {
                    name: file.path,
                    file: file,
                    };
                })
                ),
                showResultIcons: false,
                placeholder: 'Search for a file...',
                errorMessage: 'File not found',
            });

            searchControl.addTo(map);
            searchControl.markGeocode = function (result) {
                map.fitBounds(result.file.layer.getBounds());
            };
        }


        fetch(url_to_geotiff_file)
          .then(response => response.arrayBuffer())
          .then(arrayBuffer => {
            parseGeoraster(arrayBuffer).then(georaster => {
              console.log("georaster:", georaster);

              /*
                  GeoRasterLayer is an extension of GridLayer,
                  which means can use GridLayer options like opacity.
                  Just make sure to include the georaster option!
                  http://leafletjs.com/reference-1.2.0.html#gridlayer
              */
              var layer = new GeoRasterLayer({
                  georaster: georaster,
                  opacity: 0.7
              });
              layer.addTo(map);

              map.fitBounds(layer.getBounds());

          });
        });
    </script>
</body>

</html>
